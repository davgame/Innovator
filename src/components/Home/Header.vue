<template v-if="authStore.profile">
  <nav class="border-gray-200 bg-[#FFFFFF]">
    <div class="flex fixed top-0 left-0 w-full bg-white shadow-2xs z-50 items-center justify-between px-6 py-4 sm:px-6 md:px-[100px] lg:px-[80px]">
      <!--–õ–æ–≥–æ—Ç–∏–ø-->
      <div href="#" class="flex items-start space-x-3 w-1/2">
        <img src="/src/assets/images/Logo_menu1.png" alt="Innova" class="w-[42px] h-auto"/>
        <div class="text-left">
          <h1 class="text-[17px] font-rubik text-black font-bold">–ò–Ω–Ω–æ–≤–∞—Ç–æ—Ä—ã</h1>
          <p class="text-[13px] mt-[-4px] font-rubik text-black font-medium">–ö—Ä–∞—Å–Ω–æ–¥–∞—Ä</p>
        </div>
      </div>
        <!-- üîç –ü–û–ò–°–ö (–≤—Å–µ–≥–¥–∞ –≤–∏–¥–µ–Ω, –ø–æ —Ü–µ–Ω—Ç—Ä—É) -->
      <div class="flex items-center lg:gap-4">
        <SearchUsers />

        <RouterLink
          v-if="authStore.profile"
          to="/profile"
          class="flex items-center gap-2"
          @click="isOpen = false"
        >
          <!-- –ï—Å–ª–∏ –µ—Å—Ç—å avatar_url - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ -->
          <img
            v-if="authStore.profile?.avatar_url"
            :src="authStore.profile.avatar_url + '?v=' + avatarVersion"
            class="lg:block hidden w-[42px] h-[42px] rounded-full object-cover"
            alt="Avatar"
          />
          <!-- –ï—Å–ª–∏ –Ω–µ—Ç –∞–≤–∞—Ç–∞—Ä–∞ - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–∞—Ä—Ç–∏–Ω–∫—É-—ç–º–æ–¥–∑–∏ –≤ —Å–∏–Ω–µ–º –∫—Ä—É–≥–µ -->
          <div
            v-else
            class="lg:flex hidden w-[42px] h-[42px] rounded-full bg-[#CFD9FF] items-center justify-center"
          >
            <img
              src="/src/assets/images/Emodzi.svg"
              class="w-[30px] h-[30px] object-contain"
              alt="Default avatar"
            />
          </div>

        </RouterLink>
          <!-- –ï—Å–ª–∏ –Ω–µ—Ç –ø—Ä–æ—Ñ–∏–ª—è - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫–∏ -->
        <template v-else>
          <RouterLink
            to="/authorization?tab=auth"
            @click="isOpen = false"
            class="desktop-button mr-[3px] text-black focus:ring-4 focus:ring-blue-300 font-rubik font-medium rounded-[10px] border-1 text-sm px-[35px] py-2.5 focus:outline-none border-[#9A9A9A]/20 hover:bg-gray-100"
          >
            –í–æ–π—Ç–∏
          </RouterLink>
          <RouterLink
            to="/register?tab=register"
            class="desktop-button mr-[15px] text-white bg-[#4286F7] hover:bg-[#222222] focus:ring-4 focus:ring-blue-300 font-rubik border-[#9A9A9A]/20 font-medium rounded-[10px] text-sm px-5 py-2.5 focus:outline-none"
          >
            –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è
          </RouterLink>
        </template>
        <button
        @click="isOpen = !isOpen"
        type="button"
        class="cursor-pointer inline-flex items-center justify-center p-2 w-10 h-10 text-sm text-[#111827] border-1 border-[#9A9A9A]/20 rounded-lg hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-gray-200"
        aria-controls="navbar-hamburger"
        aria-expanded="false"
      >
        <span class="sr-only">Open main menu</span>
        <svg
          class="w-5 h-5"
          aria-hidden="true"
          xmlns="http://www.w3.org/2000/svg"
          fill="none"
          viewBox="0 0 17 14"
        >
          <path
            stroke="currentColor"
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M1 1h15M1 7h15M1 13h15"
          />
        </svg>
      </button>
      </div>
    </div>
    <!-- –î–æ–±–∞–≤–ª—è–µ–º –æ—Ç—Å—Ç—É–ø, —á—Ç–æ–±—ã –∫–æ–Ω—Ç–µ–Ω—Ç –Ω–µ –ø–µ—Ä–µ–∫—Ä—ã–≤–∞–ª—Å—è –º–µ–Ω—é -->
    <div class="pt-[45px]">
      <!-- –ó–¥–µ—Å—å –æ—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç —Å—Ç—Ä–∞–Ω–∏—Ü—ã -->
    </div>



    <!-- FULLSCREEN –ú–ï–ù–Æ -->
    <Transition name="slide-menu">

    <div v-show="isOpen" class="fixed inset-0 bg-[#4286F7] text-white flex flex-col transition-all duration-300 z-50">
      <div class="flex items-center justify-between px-6 py-4 sm:px-6 md:px-[100px] lg:px-[80px] no-scrollbar">

        <!--–õ–æ–≥–æ—Ç–∏–ø-->
        <div href="#" class="flex items-sart space-x-3 w-1/2">
          <img src="/src/assets/images/Logo_menu2.png" alt="Innova" class="w-[42px] h-auto" />
          <div class="text-left">
            <h1 class="text-[17px] font-rubik text-white font-bold">–ò–Ω–Ω–æ–≤–∞—Ç–æ—Ä—ã</h1>
            <p class="text-[13px] mt-[-4px] font-rubik text-white font-medium">–ö—Ä–∞—Å–Ω–æ–¥–∞—Ä</p>
          </div>
        </div>
        <!-- –ü—Ä–∞–≤–∞—è —á–∞—Å—Ç—å: –ø–æ–∏—Å–∫ + –∞–≤–∞—Ç–∞—Ä + –∫–Ω–æ–ø–∫–∞ –∑–∞–∫—Ä—ã—Ç–∏—è -->
      <div class="flex items-center gap-4 ml-auto px-4">

         <!-- –ê–≤–∞—Ç–∞—Ä -->
        <RouterLink
          v-if="authStore.profile"
          :to="{ name: 'MyProfile' }"
          @click="isOpen = false">

          <img
            v-if="authStore.profile?.avatar_url"
            :src="authStore.profile.avatar_url + '?v=' + avatarVersion"
            class="w-[42px] h-[42px] rounded-full object-cover border-2 border-white"
            alt="Avatar"
          />
          <!-- –ï—Å–ª–∏ –Ω–µ—Ç –∞–≤–∞—Ç–∞—Ä–∞ - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–∞—Ä—Ç–∏–Ω–∫—É-—ç–º–æ–¥–∑–∏ –≤ —Å–∏–Ω–µ–º –∫—Ä—É–≥–µ -->
          <div
            v-else
            class="lg:flex w-[42px] h-[42px] rounded-full bg-[#CFD9FF] flex items-center justify-center"
          >
            <img
              src="/src/assets/images/Emodzi.svg"
              class="lg:w-[30px] lg:h-[30px] w-[26px] h-[26px] object-contain"
              alt="Default avatar"
            />
          </div>
          </RouterLink>

          <template v-else>
            <RouterLink
              to="/authorization?tab=auth"
              @click="isOpen = false"
              class="desktop-button mr-[3px] text-white focus:ring-4 focus:ring-blue-300 font-rubik font-medium rounded-[10px] border-1 text-sm px-[35px] py-2.5 focus:outline-none border-white"
            >
              –í–æ–π—Ç–∏
            </RouterLink>
            <RouterLink
              to="/authorization?tab=register"
              @click="isOpen = false"
              class="desktop-button mr-[15px] text-[#4286F7] bg-white focus:ring-4 focus:ring-blue-300 font-rubik font-medium rounded-[10px] text-sm px-5 py-2.5 focus:outline-none"
            >
              –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è
            </RouterLink>
          </template>
        </div>

        <button
          @click="isOpen = false"
          class="cursor-pointer w-10 h-10 grid place-items-center border border-white rounded-lg text-white"
        >
          <span class="text-3xl leading-none py-[2px] mb-[4px]">√ó</span>
        </button>
      </div>

      <div class="container mx-auto">
        <div class="w-full h-[1px]  bg-gray-100 my-1 max-w-[calc(100%-3rem)] lg:max-w-[calc(100%-1rem)] mx-auto"></div>
      </div>
      <!--–ò–Ω–Ω–æ–≤–∞—Ç–æ—Ä—ã –ø—Ä–æ–¥—É–∫—Ç –°–ù–û-->
      <div class="flex items-start justify-start m-2 flex-1 sm:flex-none sm:justify-start sm:pl-4">
        <div
          class="hidden lg:inline-block h-full flex-col justify-between w-full md:ml-[87px] sm:ml-4 sm:mt-4 md:mt-[250px]"
        >
          <h1
            class="md:transform md:rotate-90 md:text-[80px] lg:text-[100px] text-left lg:transform lg:rotate-0 font-bold text-[#9CB8FF]"
          >
            –ò–Ω–Ω–æ–≤–∞—Ç–æ—Ä—ã
          </h1>
          <p
            class="md:rotate-90 md:text-[18px] md:mr-[72px] lg:text-[32px] text-left lg:transform lg:rotate-0 font-regular mt-[-8px] text-[#9CB8FF] whitespace-nowrap"
          >
            –ü—Ä–æ–¥—É–∫—Ç –°–ù–û –ö–£–±–ì–¢–£
          </p>
          <div class="flex space-x-8 mt-36">
            <a href="#" target="_blank">
              <img src="/src/assets/images/vk.png" alt="VK" class="w-12 h-12" />
            </a>
            <a href="#" target="_blank">
              <img src="/src/assets/images/tg.png" alt="Telegram" class="w-12 h-12" />
            </a>
            <a href="#" target="_blank">
              <img src="/src/assets/images/whatsapp.png" alt="whatsapp" class="w-12 h-12" />
            </a>
          </div>
        </div>

        <!-- –ù–∞–≤–∏–≥–∞—Ü–∏—è –ø–æ —Ü–µ–Ω—Ç—Ä—É -->
        <nav class="flex flex-col justify-start items-start w-full pl-12 pr-4 text-[55px] md:text-[55px] md:pr-[35px] lg:text-[85px] lg:mr-[30px] lg:max-w-none"
        >
          <router-link
            to="/"
            click.prevent="goToPage('/')"
            class="hover:text-[#FFBA26] ml-auto mb-2"
          >
            –≥–ª–∞–≤–Ω–∞—è
          </router-link>
          <a href="#" @click="isOpen = false" class="hover:text-[#FFBA26] ml-auto mb-2">–∫–∞–Ω–±–∞–Ω</a>
          <a href="#" @click="isOpen = false" class="hover:text-[#FFBA26] ml-auto mb-2">–æ—Ç–∫–ª–∏–∫–∏</a>
          <router-link to="/faq" @click="isOpen = false" class="hover:text-[#FFBA26] ml-auto mb-2">faq</router-link>
          <router-link to="/contact" @click="isOpen = false" class="hover:text-[#FFBA26] ml-auto">–∫–æ–Ω—Ç–∞–∫—Ç—ã</router-link>

          <div class="flex justify-end w-full lg:hidden mt-5">
            <a
              href="#"
              class="w-[240px] h-[64px] text-[#4286F7] bg-white focus:ring-4 focus:ring-blue-300 font-medium rounded-[20px] text-center text-[27px] px-5 py-2.5 focus:outline-none"
            >
              –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è
            </a>
          </div>
          <div class="flex justify-end w-full space-x-8 mt-10 lg:hidde">
            <a href="#" target="_blank">
              <img src="/src/assets/images/vk.png" alt="VK" class="w-10 h-10 block lg:hidden" />
            </a>
            <a href="#" target="_blank">
              <img
                src="/src/assets/images/tg.png"
                alt="Telegram"
                class="w-10 h-10 block lg:hidden"
              />
            </a>
            <a href="#" target="_blank">
              <img
                src="/src/assets/images/whatsApp.png"
                alt="whatsApp"
                class="w-10 h-10 block lg:hidden"
              />
            </a>
          </div>
        </nav>
      </div>
    </div>
    </Transition>
  </nav>
</template>

<style scoped>
  /* –í–´–ï–ó–î –ú–ï–ù–Æ –°–ü–†–ê–í–ê */
.slide-menu-enter-from {
  transform: translateX(100%);
}

.slide-menu-enter-to {
  transform: translateX(0);
}

.slide-menu-leave-from {
  transform: translateX(0);
}

.slide-menu-leave-to {
  transform: translateX(100%);
}

.slide-menu-enter-active,
.slide-menu-leave-active {
  transition: transform 0.35s ease-in-out;
}

@media (max-width: 1023px) {
  .desktop-button {
    display: none;
  }
}

/* –°–∫—Ä—ã–≤–∞–µ–º —Å–∫—Ä–æ–ª–ª–±–∞—Ä */
.no-scrollbar::-webkit-scrollbar {
  display: none;
}
.no-scrollbar {
  -ms-overflow-style: none;  /* IE –∏ Edge */
  scrollbar-width: none;      /* Firefox */
}
</style>

<script setup>
import { ref, watch } from 'vue'
import { RouterLink, useRouter } from 'vue-router'
import { useAuthStore } from '@/stores/auth'
import SearchUsers from './SearchUsers.vue'

const authStore = useAuthStore()
const avatarVersion = ref(Date.now()) // üëà –¥–ª—è —Å–±—Ä–æ—Å–∞ –∫—ç—à–∞
const router = useRouter()
const isOpen = ref(false)

// –§–ª–∞–≥ –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö –Ω–∞–≤–∏–≥–∞—Ü–∏–π
let isNavigating = false

const goToPage = (path) => {
  // –ï—Å–ª–∏ —É–∂–µ –∏–¥–µ—Ç –Ω–∞–≤–∏–≥–∞—Ü–∏—è - –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º
  if (isNavigating) return

  const currentPath = router.currentRoute.value.path

  // –ï—Å–ª–∏ –º—ã –£–ñ–ï –Ω–∞ —ç—Ç–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü–µ - –ø—Ä–æ—Å—Ç–æ –∑–∞–∫—Ä—ã–≤–∞–µ–º –º–µ–Ω—é
  if (currentPath === path) {
    isOpen.value = false
    return
  }

  // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ñ–ª–∞–≥ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏
  isNavigating = true

  // –°–Ω–∞—á–∞–ª–∞ –∑–∞–∫—Ä—ã–≤–∞–µ–º –º–µ–Ω—é (–∑–∞–ø—É—Å–∫–∞–µ–º –∞–Ω–∏–º–∞—Ü–∏—é)
  isOpen.value = false

  // –ñ–¥–µ–º –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –∞–Ω–∏–º–∞—Ü–∏–∏ –∑–∞–∫—Ä—ã—Ç–∏—è –º–µ–Ω—é
  setTimeout(() => {
    // –ü–µ—Ä–µ—Ö–æ–¥–∏–º –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É
    router.push(path)

    // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–ª–∞–≥ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏
    isNavigating = false
  }, 350) // 350ms —Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å—é –∞–Ω–∏–º–∞—Ü–∏–∏ slide-menu
}

// üëá –°–ª–µ–¥–∏–º –∑–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è–º–∏ –≤ sessionStorage
watch(() => sessionStorage.getItem('avatarUpdated'), (newVal) => {
  if (newVal) {
    avatarVersion.value = Date.now()
  }
})

// üëá –°–ª–µ–¥–∏–º –∑–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è–º–∏ –∞–≤–∞—Ç–∞—Ä–∞
watch(() => authStore.profile?.avatar_url, (newUrl) => {
  console.log('Avatar URL changed in header:', newUrl)
  if (newUrl) {
    avatarVersion.value = Date.now()
  }
}, { immediate: true })

// üëá –î–æ–±–∞–≤–∏–º –∏–Ω—Ç–µ—Ä–≤–∞–ª –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ (–∑–∞–ø–∞—Å–Ω–æ–π –≤–∞—Ä–∏–∞–Ω—Ç)
setInterval(() => {
  if (authStore.profile?.avatar_url) {
    avatarVersion.value = Date.now()
  }
}, 5000) // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–∞–∂–¥—ã–µ 5 —Å–µ–∫—É–Ω–¥

// –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ —Å–∫—Ä–æ–ª–ª–∞ –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–æ–º –º–µ–Ω—é
watch(isOpen, (value) => {
  document.body.style.overflow = value ? 'hidden' : ''
})

// –ó–∞–∫—Ä—ã—Ç–∏–µ –º–µ–Ω—é –ø—Ä–∏ –ø–µ—Ä–µ—Ö–æ–¥–µ –ø–æ –º–∞—Ä—à—Ä—É—Ç—É
watch(() => router.currentRoute.value, () => {
  if (isOpen.value) {
    isOpen.value = false
  }
})

// üëá –°–ª–µ–¥–∏–º –∑–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è–º–∏ –∞–≤–∞—Ç–∞—Ä–∞
watch(() => authStore.profile?.avatar_url, (newUrl) => {
  console.log('Avatar URL changed in header:', newUrl)
    if (newUrl) {
    avatarVersion.value = Date.now() // üëà –æ–±–Ω–æ–≤–ª—è–µ–º –≤–µ—Ä—Å–∏—é –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏
  }
}, { immediate: true })

const handleImageError = (e) => {
  console.log('Image failed to load, using fallback')
  e.target.style.display = 'none'
  // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–∏—Ü–∏–∞–ª—ã
}

// üëá –°–ª–µ–¥–∏–º –∑–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è–º–∏ –ø—Ä–æ—Ñ–∏–ª—è
watch(() => authStore.profile, (newProfile) => {
  console.log('Profile changed:', newProfile)
}, { immediate: true })
</script>
